<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claim & Withdrawal History</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
<style>
body{font-family:Poppins,sans-serif;background:#f5f5f5;margin:0;padding:0;}
.header{padding:1rem;text-align:center;background:#2e7d32;color:#fff;font-weight:600;position:sticky;top:0;}
.back-btn{position:absolute;left:10px;top:12px;background:#fff;color:#2e7d32;padding:6px 12px;border-radius:8px;cursor:pointer;border:none;}
.history-card{background:#fff;margin:15px;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.15);}
.history-card p{margin:6px 0;font-size:14px;color:#333;}
</style>
</head>
<body>

<div class="header">
  <button class="back-btn" onclick="goBack()">Back</button>
  Claim & Withdrawal History
</div>

<div id="historyContainer">
  <p>Loading history...</p>
</div>

<script>
const CONTRACT_ADDRESS = "0x9fd473975cecd4587d78eb71f4498dde778c4b83";
const ABI = [ 
  "event RewardClaimed(address indexed user, uint256 amountNet, uint256 fee)",
  "event PrincipalWithdrawn(address indexed user, uint256 stakeIndex, uint256 amount, uint256 fee)"
];

let provider, signer, contract, userAddress;

async function loadHistory() {
  if (window.ethereum) {
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
    fetchHistory();
  } else {
    document.getElementById("historyContainer").innerHTML = "<p>Wallet not detected. Please connect from main DApp.</p>";
  }
}

async function fetchHistory() {
  try {
    const container = document.getElementById("historyContainer");
    container.innerHTML = "";

    // RewardClaimed events
    const rewardFilter = contract.filters.RewardClaimed(userAddress);
    const rewardEvents = await contract.queryFilter(rewardFilter, 0, "latest");

    // PrincipalWithdrawn events
    const withdrawFilter = contract.filters.PrincipalWithdrawn(userAddress);
    const withdrawEvents = await contract.queryFilter(withdrawFilter, 0, "latest");

    if(rewardEvents.length === 0 && withdrawEvents.length === 0){
      container.innerHTML = "<p>No history found.</p>";
      return;
    }

    // Merge events by block timestamp
    const allEvents = [];
    for(const e of rewardEvents){
      const block = await provider.getBlock(e.blockNumber);
      allEvents.push({
        type:"RewardClaimed",
        stakeIndex:null,
        amount:ethers.utils.formatEther(e.args.amountNet),
        fee:ethers.utils.formatEther(e.args.fee),
        timestamp:new Date(block.timestamp*1000).toLocaleString()
      });
    }
    for(const e of withdrawEvents){
      const block = await provider.getBlock(e.blockNumber);
      allEvents.push({
        type:"PrincipalWithdrawn",
        stakeIndex:e.args.stakeIndex.toString(),
        amount:ethers.utils.formatEther(e.args.amount),
        fee:ethers.utils.formatEther(e.args.fee),
        timestamp:new Date(block.timestamp*1000).toLocaleString()
      });
    }

    // Sort by timestamp descending
    allEvents.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));

    // Display
    for(const ev of allEvents){
      container.innerHTML += `
        <div class="history-card">
          <p><b>${ev.type}</b></p>
          ${ev.stakeIndex!==null?`<p>Stake #: ${ev.stakeIndex}</p>`:""}
          <p>Amount Received: ${ev.amount} Navaa</p>
          <p>Fee Deducted: ${ev.fee} Navaa</p>
          <p>Time: ${ev.timestamp}</p>
        </div>
      `;
    }

  } catch(err){ 
    console.error(err); 
    document.getElementById("historyContainer").innerHTML="<p>Error loading history.</p>"; 
  }
}

function goBack(){ window.location.href="index.html"; }

loadHistory();
</script>
</body>
</html>
