<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Navaa Staking History</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
body {
  font-family: 'Poppins', sans-serif;
  background: #f5f5f5;
  margin:0;
}
.header {
  position: fixed; top:0; left:0; width:100%;
  background:#fff; padding:12px; display:flex; align-items:center; gap:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1); z-index:100;
}
.header button {
  margin-left:auto; padding:8px 14px; border-radius:8px; border:none; background:#5a67d8; color:#fff; cursor:pointer;
}
.main-content { margin-top:70px; padding:20px; }
.history-card {
  background:#fff; padding:16px; border-radius:12px; margin-bottom:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
.history-card p { margin:4px 0; }
.loading { text-align:center; padding:20px; font-weight:600; }
</style>
</head>
<body>

<header class="header">
  <h2>History</h2>
  <button onclick="goBack()">Back</button>
</header>

<div class="main-content" id="historyContainer">
  <p class="loading">Loading history...</p>
</div>

<script>
const CONTRACT_ADDRESS = "0x9fd473975cecd4587d78eb71f4498dde778c4b83"; // Replace with your contract
const ABI = [
  "event RewardClaimed(address indexed user,uint256 amountNet,uint256 fee)",
  "event PrincipalWithdrawn(address indexed user,uint256 stakeIndex,uint256 amount,uint256 fee)"
];
let provider, contract, userAddress;

async function init() {
  if (!window.ethereum) { alert("Please install MetaMask!"); return; }
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  const network = await provider.getNetwork();
  if(network.chainId!==137){ alert("Switch to Polygon Mainnet"); return; }
  const signer = provider.getSigner();
  userAddress = await signer.getAddress();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
  fetchHistory();
}

async function fetchHistory() {
  try {
    const container = document.getElementById("historyContainer");
    container.innerHTML = "<p class='loading'>Loading history...</p>";

    const latestBlock = await provider.getBlockNumber();
    const fromBlock = 0; // Optional: contract deployment block for faster load

    // RewardClaimed
    const rewards = await contract.queryFilter(contract.filters.RewardClaimed(userAddress), fromBlock, latestBlock);
    // PrincipalWithdrawn
    const withdraws = await contract.queryFilter(contract.filters.PrincipalWithdrawn(userAddress), fromBlock, latestBlock);

    if (rewards.length===0 && withdraws.length===0) {
      container.innerHTML = "<p>No history found.</p>";
      return;
    }

    const allEvents = [];

    for(const e of rewards){
      const block = await provider.getBlock(e.blockNumber);
      allEvents.push({
        type:"Claim",
        stakeIndex:"-",
        amount:ethers.utils.formatEther(e.args.amountNet),
        fee:ethers.utils.formatEther(e.args.fee),
        timestamp:new Date(block.timestamp*1000).toLocaleString()
      });
    }

    for(const e of withdraws){
      const block = await provider.getBlock(e.blockNumber);
      allEvents.push({
        type:"Withdrawal",
        stakeIndex:e.args.stakeIndex.toString(),
        amount:ethers.utils.formatEther(e.args.amount),
        fee:ethers.utils.formatEther(e.args.fee),
        timestamp:new Date(block.timestamp*1000).toLocaleString()
      });
    }

    allEvents.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));

    container.innerHTML = "";
    for(const ev of allEvents){
      container.innerHTML += `
        <div class="history-card">
          <p><b>${ev.type}</b></p>
          ${ev.stakeIndex!=="-"? `<p>Stake #: ${ev.stakeIndex}</p>` : ""}
          <p>Amount Received: ${ev.amount} Navaa</p>
          <p>Fee Deducted: ${ev.fee} Navaa</p>
          <p>Time: ${ev.timestamp}</p>
        </div>
      `;
    }
  } catch(err){
    console.error(err);
    document.getElementById("historyContainer").innerHTML = "<p>Error loading history.</p>";
  }
}

function goBack() { window.location.href="index.html"; } // Back to main dapp

init();
</script>

</body>
</html>
